main:
  params: [event]
  steps:
    - read_blob_metadata:
        call: googleapis.storage.v1.objects.get
        args:
          bucket: ${event.data.bucket}
          object: ${text.url_encode(event.data.name)}
        result: blob
    - set_variables:
        assign:
          - project_id: ${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
          - job_name: ${blob["metadata"]["job_name"]}
          - job_location: ${sys.get_env("GOOGLE_CLOUD_LOCATION")}
          - proceso_id: ${blob["metadata"]["proceso_id"]}
    - run_job:
        call: googleapis.run.v1.namespaces.jobs.run
        args:
          name: ${"namespaces/" + project_id + "/jobs/" + job_name}
          location: ${job_location}
          body:
            overrides:
              containerOverrides:
                  env:
                    - name: "PROCESO_ID"
                      value: ${proceso_id}
                    - name: "INPUT_FILE"
                      value: ${"gs://" + event.data.bucket + "/" + event.data.name}
          connector_params:
            polling_policy:
              initial_delay: 30
              multiplier: 1.20
              max_delay: 60
            skip_polling: false
        result: job_execution